\newcommand*{\pdfnumberofpages}[1]{\directlua{%
		tex.write(cantus.getPDFpagesCount("\luaescapestring{#1}"))%
	}}

\newdimen{\gregoLineSkip}
\setlength{\gregoLineSkip}{1.8cm plus 2mm minus 2mm}
\newcommand{\cantusInternal}[1]{%
	\prevdepth=-\maxdimen%
	\begingroup%
	\def\pdfFile{../../content/gabc/build/#1.pdf}%
	\setlength{\parindent}{0pt}%
	\setlength{\baselineskip}{\gregoLineSkip}%
	\setlength{\lineskip}{0pt plus 1mm}%
	\loopoverpages{0}{\pdfnumberofpages{\pdfFile}}%
	\endgroup%
}

\def\loopoverpages#1#2{%
	\begingroup%
	\count0=#1
	\count1=#2%
	\advance\count0 by 1%
	\hbox to \textwidth{\lower\gregoLineDepth\hbox{\includegraphics[page=\count0, scale=1]{\pdfFile}}\hfill}%
	\ifnum\count0<\count1\loopoverpages{\the\count0}{\the\count1}\fi%
	\endgroup%
}

\newcommand{\cantus}[1]{%
	\cantusInternal{#1}%
}
\newcommand{\cantusTRAD}[3][0]{%%
	\cantusTradFrame{%
		\cantusInternal{#2}%
	}{%
		\setlength{\parskip}{0pt}%
		\sloppy\ttrad%
		\frenchpar{\noindent#3}%
		\vfill%
	}%
}

\newdimen{\cantusTradWidth}%
\setlength{\cantusTradWidth}{3.5cm}%
\newbox\cantusBox%
\newbox\translationBox%
\def\cantusParam{}%
\def\translationParam{}%
\newcommand{\cantusTradFrame}[2]{%
	\def\cantusParam{#1}%
	\def\translationParam{#2}%
	\resetBoxesContent%
	%\beforeCols%
	\expandCantusOverPages%
}
\def\resetBoxesContent{%
	\setbox\cantusBox=\vbox{\cantusParam}%
	\setbox\translationBox=\vbox{\hsize=\cantusTradWidth \translationParam}%
}
\def\beforeCols{%
	\prevdepth=-\maxdimen\hbox{}\prevdepth=-\maxdimen%
}
\def\expandCantusOverPages{
	\setThisPageContent%
	\ifvoid\cantusBox\else\eject\expandCantusOverPages\fi%
}
\newbox\pageBoxCantus%
\newbox\pageBoxTranslation%
\newdimen{\cantusTradTopSkip}%
\setlength{\cantusTradTopSkip}{2mm}%
\def\setThisPageContent{%
	\updateSpaceLeft%
	\setbox\pageBoxCantus=\vsplit\cantusBox to\spaceLeft%
	\shrinkBoxIfNotFullPage\pageBoxCantus%
	\ifdim\ht\pageBoxCantus>\spaceLeft%
		\resetBoxesContent%
	\else%
		\setbox\translationBox=\vbox{\vskip\cantusTradTopSkip\unvbox\translationBox}%
		\setbox\pageBoxTranslation=\vsplit\translationBox to\ht\pageBoxCantus%
		\ht\pageBoxTranslation=\ht\pageBoxCantus%
		\hbox to\hsize{\box\pageBoxCantus\hskip-\cantusTradWidth\box\pageBoxTranslation}%
	\fi%
}
\def\shrinkBoxIfNotFullPage#1{%
	\ifdim\pagetotal>0pt%
		\shrinkBox#1%
	\fi%
	\ifvoid\cantusBox%
		\shrinkBox#1%
	\fi
}
\def\shrinkBox#1{%
	\let\inputBoxToShrink#1%
	\setbox\inputBoxToShrink=\vbox{\unvbox\inputBoxToShrink}%
}
