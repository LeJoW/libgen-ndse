\newcommand*{\pdfnumberofpages}[1]{\directlua{%
		local doc = pdfe.open("\luaescapestring{#1}")
		local pages
		if (doc) then
		pages = pdfe.getnofpages(doc)
		else
		pages = 0
		end
		tex.write(pages)
	}}

\newcommand{\storeObjHeight}[2]{\settoheight{#1}{\vbox{#2}}}

\def\privateHeightsList{0pt}
\newcommand{\resetHeightsList}{\def\privateHeightsList{0pt}}
\newlength{\singleGregoLineHeight}
\newlength{\singleGregoLineDepth}
\newcommand{\pushHeightOf}[1]{%
	\settoheight{\singleGregoLineHeight}{\hbox{#1}}%
	\settodepth{\singleGregoLineDepth}{\hbox{#1}}%
	\addtolength{\singleGregoLineHeight}{\singleGregoLineDepth}%
	\addtolength{\singleGregoLineHeight}{\gregoLineSkip}%
	\global\edef\privateHeightsList{\privateHeightsList, \the\singleGregoLineHeight}%%%
}

\newcounter{gabcCount}
\newlength{\gregoLineSkip}
\setlength{\gregoLineSkip}{1.8cm plus 2mm minus 2mm}
\newcommand{\cantusInternal}[1]{%
	\setcounter{gabcCount}{0}%
	{%
		\def\pdfFile{../../content/gabc/build/#1.pdf}%
		\setlength{\parindent}{0pt}%
		\setlength{\baselineskip}{\gregoLineSkip}%
		\setlength{\lineskip}{0pt}%
		\whiledo{\value{gabcCount}<\pdfnumberofpages{\pdfFile}}{%
			\stepcounter{gabcCount}%
			\def\gline{\vbox{\raisebox{-\gregoLineDepth}{\includegraphics[page=\thegabcCount, width=\textwidth]{\pdfFile}}}}%
			\pushHeightOf{\gline}%
			\gline\penalty0%
		}%
	}%
}

\newlength{\privateAutoSumForAccumulator}
\newcommand{\autoPrintGapFromHeights}[2]{%
	\setlength{\privateAutoSumForAccumulator}{-#2}%
	\foreach \x in #1 {%
			\addtolength{\privateAutoSumForAccumulator}{\x}%
			\global\privateAutoSumForAccumulator=\privateAutoSumForAccumulator
			\ifdim\privateAutoSumForAccumulator>0pt%
				\breakforeach%
			\fi%
		}%
	\addtolength{\privateAutoSumForAccumulator}{-\gregoLineSkip}%
	\ifdim\privateAutoSumForAccumulator>0pt%
		\vspace*{\privateAutoSumForAccumulator}%
	\fi%
}

\newlength{\privateSumForAccumulator}
\newcommand{\printGapFromHeights}[2]{%
	\setlength{\privateSumForAccumulator}{0pt}%
	\foreach \x [count=\n] in #1 {%
			\addtolength{\privateSumForAccumulator}{\x}%
			\global\privateSumForAccumulator=\privateSumForAccumulator%
			\ifnum\n=#2%
				\breakforeach%
			\fi%
		}%
	\addtolength{\privateSumForAccumulator}{-\gregoLineSkip}%
	\ifdim\privateSumForAccumulator>0pt%
		\vspace*{\privateSumForAccumulator}%
	\fi%
}

\mdfdefinestyle{floatTradStyle}{
	leftmargin=0pt,
	rightmargin=-1pt,
	skipabove=0pt,
	skipbelow=0pt,
	innertopmargin=2mm,
	innerleftmargin=2mm,
	innerrightmargin=0pt,
	innerbottommargin=0pt,
	backgroundcolor=white,
	linecolor=white
}

\newlength{\frameHeight}
\newlength{\emptyFrameHeight}
\setlength{\emptyFrameHeight}{0pt}
\newcommand{\sizedFrame}[2]{%
\setlength{\frameHeight}{0pt}%
\storeObjHeight{\emptyFrameHeight}{{\begin{mdframed}[style=floatTradStyle]\end{mdframed}}}%
\storeObjHeight{\frameHeight}{{\begin{mdframed}[style=floatTradStyle]#1\end{mdframed}}}%
\addtolength{\frameHeight}{-\emptyFrameHeight}%
\ifnum #2>0%
	\def\gapToAdd{\printGapFromHeights{\privateHeightsList}{#2}}
\else
	\def\gapToAdd{\autoPrintGapFromHeights{\privateHeightsList}{\the\frameHeight}}
\fi
{\begin{mdframed}[style=floatTradStyle]#1\gapToAdd\end{mdframed}}%
}

\newcommand{\cantus}[1]{%
	\cantusInternal{#1}%
	\par%
}
\newcommand{\cantusTRAD}[3][0]{%%
	\resetHeightsList%%
	\twosided[p]%%
	\setcolumnwidth{,3.65cm}%%
	\setlength\columnseprule{0pt}%%
	\renewcommand{\italic}[1]{\it\decorativ ##1}%
	\vspace{\parskip}%
	\begingroup%
	\let\storeParskip\parskip%
	\setlength{\parskip}{0pt}%
	\hrule width\textwidth height0pt depth0pt%
	\begin{paracol}{2}%%
		\prevdepth=-\maxdimen%
		\setlength{\parskip}{\storeParskip}%
		\cantusInternal{#2}%%
		\switchcolumn%%
		\sloppy%
		{\sizedFrame{\frenchpar{\ttrad #3}}{#1}}%
	\end{paracol}%%
	\endgroup%
	\par%
}
