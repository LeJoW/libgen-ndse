\directlua{dofile("\CurrentFilePath" .. "/page-crop.lua")}

\newcommand{\enablePageCropping}{\directlua{pageCrop.enable()}}

\newcommand{\getHeightOfPage}[1]{\directlua{tex.sprint(pageCrop.getHeightOfPage(#1) .. "sp")}}

\makeatletter
\newcommand{\convert}[1]{\strip@pt\dimexpr0.996264009963#1\relax}
\makeatother

\makeatletter
\newdimen{\new@pageheight}
\newdimen{\given@pageheight}
\AtBeginShipout{%
\setlength{\given@pageheight}{\getHeightOfPage{\thepage}}%
\new@pageheight=\dimexpr\pagegoal-\given@pageheight\relax%
\edef\mypdfpageattr{/CropBox [0 \convert{\new@pageheight} \convert{\paperwidth} \convert{\paperheight}]}%
\expandafter\pdfpageattr\expandafter{\mypdfpageattr}%
}
\makeatother

\let\oldGreSetThisSyllable\GreSetThisSyllable
\renewcommand{\GreSetThisSyllable}[5]{\oldGreSetThisSyllable{#1\strut[\gregoLineDepth]}{#2}{#3}{#4}{#5}}
