\newinsert\translationins
\count\translationins=0
\skip\translationins=0pt
\dimen\translationins=\maxdimen

\long\def\begintranslation#1\endtranslation of cantus #2{\begingroup\hbadness=10000
		\selectpdf{#2}\dimen7=\pdffirstht%
		\computestrutheightfor{\vbox{\hsize=\translationwidth\noindent #1}}%
		\setbox\translationbox=\vbox{\hsize=\translationwidth\noindent\strut\dimen0 #1}%
		\updatefreespace%
		\dimen0=\ifdim\freespace>\dimen7 \freespace\else\textheight\fi%
		\advance\dimen0 by -\pagestretch%
		\advance\dimen0 by \pageshrink%
		\setbox0=\vsplit\translationbox upto \dimen0%
		\setbox\translationbox=\box\translationbox%
		\ifvoid\translationbox\else\insert\translationins{\unvbox\translationbox}
			\wd\translationins=\translationwidth\fi%
		\ht0=0pt \dp0=0pt \wd0=\translationwidth%
		\hbox to \textwidth{\hfil\box0}\prevdepth=-\maxdimen%
		\rawcantus\endgroup}

\def\cantus#1{\selectpdf{#1}\rawcantus}

\def\rawcantus{\begingroup
	\maxdepth=3mm
	\baselineskip=1.8cm plus 1pt minus 1pt
	\lineskiplimit=-1pt
	\lineskip=-1pt plus 1pt minus 1pt
	\printpdf
	\endgroup}

\def\printpdf{%
	\count100=\pdflength%
	\loop%
	\hbox to \textwidth{\lower3mm\hbox{\printnextpdfpage}\hfil}%
	\ifnum\count100>1%
	\advance \count100 by -1\repeat%
}

\def\computestrutheightfor#1{\setbox0=#1%
	\count10=\countlinesofbox0\count10=\count10%
	\count11=3\ifdim\dimen7>19mm \count11=4\fi%
	\count12=\count11\advance\count12 by 1%
	\ifnum\count10>\count12 \count10=\count11\else\advance\count10 by -1\fi%
	\dimen0=\dimen7\advance\dimen0 by -3mm\advance\dimen0 by -\count10\baselineskip}

\def\selectpdf#1{\directlua{libgen.pdf.open('\luaescapestring{#1}')}}
\def\pdflength{\directlua{tex.print(libgen.pdf.nof_pages())}}
\def\pdffirstht{\directlua{tex.print(libgen.pdf.first_page_height())}pt}
\def\printnextpdfpage{\directlua{libgen.pdf.print_next_page()}}

\def\countlinesofbox#1{\directlua{tex.print(libgen.count_lines_of(#1))}}
